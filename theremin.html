<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Theremin mobilny — pozycja (X,Y) z dx,dy + warstwa Z</title>
<style>
  :root{--bg:#0e1117;--panel:#0a1420;--fg:#e6eef8;--mut:#9fb}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg);margin:0;padding:12px}
  h1{font-size:18px;margin:0 0 10px}
  .box{background:var(--panel);border:1px solid #22364f;border-radius:12px;padding:10px;margin:8px 0}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0}
  label{min-width:120px;font-size:13px}
  input[type=range],input[type=number],select,button{background:#142233;border:1px solid #2a3d55;color:var(--fg);border-radius:8px;padding:8px}
  button{cursor:pointer}
  .value{width:76px;text-align:center}
  .mut{color:var(--mut);font-size:12px}
  .chip{display:inline-block;padding:2px 10px;border-radius:12px;border:1px solid #2a3d55;font-size:12px}
  .on{background:#0c281c;color:#93f7cc;border-color:#208d64}
  .off{background:#2a1410;color:#ffcdb1;border-color:#8d4b20}
  #canvas{width:100%;height:170px;background:#06111a;border-radius:10px}
</style>
</head>
<body>
<h1>Theremin mobilny — X↔ częstotliwość, Y↕ głośność, warstwa Z</h1>

<div class="box">
  <div class="row">
    <button id="btnAudio">Włącz audio</button>
    <button id="btnSensors">Włącz czujniki</button>
    <button id="btnCal">Kalibracja (neutral)</button>
    <button id="btnZero">Wyzeruj pozycję</button>
    <button id="btnStop">Stop</button>
    <button id="btnNote">NOTE ON</button>
    <span id="gateChip" class="chip off">gate: OFF</span>
  </div>

  <div class="mut">
    Telefon przypięty do ręki jak „leży na stole” (ekran do góry).<br>
    • <b>Lewo↔Prawo (dx)</b> → <b>częstotliwość (X)</b> • <b>Góra↕Dół (dy)</b> → <b>głośność (Y)</b> • <b>Z</b> = grubość warstwy (włożenie/wyjęcie ręki).<br>
    Brak ruchu ⇒ pozycja (X,Y,Z) utrzymuje się (dźwięk zostaje).
  </div>

  <!-- CZUJNIKI pod opisem -->
  <div class="row mut" id="sensorStatus">
    <span id="dmAvail">DeviceMotion: —</span> · <span id="doAvail">DeviceOrientation: —</span> ·
    dx: <span id="dxVal" class="value">—</span> dy: <span id="dyVal" class="value">—</span> dz: <span id="dzVal" class="value">—</span>
  </div>
</div>

<div class="box">
  <div class="row">
    <label>Zakres X (± m)</label>
    <input id="rangeX" type="number" step="0.01" value="0.25" style="width:90px">
    <label>Zakres Y (m)</label>
    <input id="rangeY" type="number" step="0.01" value="0.60" style="width:90px">
    <label>Warstwa Z (m)</label>
    <input id="rangeZ" type="number" step="0.01" value="0.15" style="width:90px">
  </div>
  <div class="row">
    <label>Oktawy Y</label>
    <input id="octaves" type="number" min="1" max="6" step="1" value="2" style="width:70px">
    <label>No-limit</label>
    <input id="noLimit" type="checkbox">
    <label>Pitch base (Hz)</label>
    <input id="pitchBase" type="number" value="220" step="1" style="width:80px">
  </div>
  <div class="row">
    <label>Smoothing</label>
    <input id="smooth" type="range" min="0" max="0.98" step="0.01" value="0.88">
    <span id="smoothVal" class="value">0.88</span>
    <label>Deadzone a (m/s²)</label>
    <input id="deadzone" type="range" min="0" max="0.25" step="0.005" value="0.02">
    <span id="deadVal" class="value">0.02</span>
    <label>Friction</label>
    <input id="fric" type="range" min="0.90" max="0.999" step="0.001" value="0.985">
    <span id="fricVal" class="value">0.985</span>
    <label>Gain max</label>
    <input id="gainMax" type="number" value="0.9" step="0.05" style="width:80px">
  </div>
  <div class="row">
    <label>Quantize</label>
    <input id="quantize" type="checkbox">
    <select id="scale">
      <option value="none">Brak</option>
      <option value="major">Dur</option>
      <option value="minor">Mol nat.</option>
      <option value="pent">Pentatonic</option>
    </select>
    <label>Oscylator</label>
    <select id="oscType">
      <option value="sine">sine</option>
      <option value="triangle">triangle</option>
      <option value="square">square</option>
      <option value="sawtooth">sawtooth</option>
    </select>
  </div>
</div>

<div class="box">
  <div style="font-weight:600;margin-bottom:4px">ADSR</div>
  <div class="row">
    <label>Attack (s)</label><input id="att" type="range" min="0" max="2" step="0.01" value="0.03"><span id="attVal" class="value">0.03</span>
    <label>Decay (s)</label><input id="dec" type="range" min="0" max="2" step="0.01" value="0.12"><span id="decVal" class="value">0.12</span>
    <label>Sustain</label><input id="sus" type="range" min="0" max="1" step="0.01" value="0.75"><span id="susVal" class="value">0.75</span>
    <label>Release (s)</label><input id="rel" type="range" min="0" max="3" step="0.01" value="0.25"><span id="relVal" class="value">0.25</span>
  </div>
  <div class="row">
    <label>Auto-gate</label><input id="autoGate" type="checkbox" checked>
    <label>Gate on</label><input id="gateOnThr" type="number" step="0.01" value="0.20" style="width:80px">
    <label>Gate off</label><input id="gateOffThr" type="number" step="0.01" value="0.12" style="width:80px">
    <label>Debounce (ms)</label><input id="debounceMs" type="number" step="10" value="150" style="width:80px">
  </div>
</div>

<canvas id="canvas" width="960" height="170"></canvas>

<div class="box">
  <div class="row mut">
    <label>Odczyty</label>
    X (m): <span id="xRead" class="value">—</span>
    Y (m): <span id="yRead" class="value">—</span>
    Z (m): <span id="zRead" class="value">—</span>
    Pitch: <span id="pitchRead" class="value">—</span>
    Vol: <span id="volRead" class="value">—</span>
    Env: <span id="envRead" class="value">—</span>
    Wave: <span id="waveRead" class="value">—</span>
  </div>
</div>

<script>
(()=>{
// ===== Pomocnicze =====
const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
const lerp=(a,b,t)=>a+(b-a)*t;

// ===== Audio graf =====
let audio=null, osc=null, env=null, volGain=null, masterGain=null, analyser=null;
let running=false, gate=false;

function initAudio(){
  if (audio) return;
  audio=new (window.AudioContext||window.webkitAudioContext)();

  osc=audio.createOscillator();
  osc.type=document.getElementById('oscType').value||'sine';
  osc.frequency.value=440;

  env=audio.createGain();       env.gain.value=0;       // ADSR
  volGain=audio.createGain();   volGain.gain.value=0;   // Y→volume
  masterGain=audio.createGain();masterGain.gain.value=parseFloat(gainMax.value);

  analyser=audio.createAnalyser(); analyser.fftSize=1024;

  osc.connect(env); env.connect(volGain); volGain.connect(masterGain);
  masterGain.connect(analyser); analyser.connect(audio.destination);
  osc.start();

  document.getElementById('oscType').addEventListener('change',()=>{ osc.type=document.getElementById('oscType').value; waveRead.textContent=osc.type; });
  gainMax.addEventListener('input',()=> masterGain.gain.value=parseFloat(gainMax.value));
}

// ADSR
const att=attEl('att'), dec=attEl('dec'), sus=attEl('sus'), rel=attEl('rel');
function attEl(id){const el=document.getElementById(id); const lbl=document.getElementById(id+'Val'); el.addEventListener('input',()=>lbl.textContent=(+el.value).toFixed(2)); return el;}
function gateOn(){
  if(!audio) return;
  const now=audio.currentTime,A=+att.value,D=+dec.value,S=+sus.value;
  env.gain.cancelScheduledValues(now);
  env.gain.setValueAtTime(env.gain.value,now);
  env.gain.linearRampToValueAtTime(1.0, now+A);
  env.gain.linearRampToValueAtTime(S,   now+A+D);
}
function gateOff(){
  if(!audio) return;
  const now=audio.currentTime,R=+rel.value;
  env.gain.cancelScheduledValues(now);
  env.gain.setValueAtTime(env.gain.value,now);
  env.gain.linearRampToValueAtTime(0.0, now+R);
}
function setGate(on){
  if (on===gate) return;
  gate=on;
  const chip=document.getElementById('gateChip');
  chip.textContent='gate: '+(on?'ON':'OFF');
  chip.classList.toggle('on',on); chip.classList.toggle('off',!on);
  document.getElementById('btnNote').textContent=on?'NOTE OFF':'NOTE ON';
  if(on) gateOn(); else gateOff();
}

// ===== UI =====
const btnAudio = document.getElementById('btnAudio');
const btnSensors=document.getElementById('btnSensors');
const btnCal=document.getElementById('btnCal');
const btnZero=document.getElementById('btnZero');
const btnStop=document.getElementById('btnStop');
const btnNote=document.getElementById('btnNote');

const rangeX=document.getElementById('rangeX');
const rangeY=document.getElementById('rangeY');
const rangeZ=document.getElementById('rangeZ');
const octaves=document.getElementById('octaves');
const noLimit=document.getElementById('noLimit');
const pitchBase=document.getElementById('pitchBase');

const smooth=document.getElementById('smooth'), smoothVal=document.getElementById('smoothVal');
const deadzone=document.getElementById('deadzone'), deadVal=document.getElementById('deadVal');
const fric=document.getElementById('fric'), fricVal=document.getElementById('fricVal');
[smooth,deadzone,fric].forEach(el=>el.addEventListener('input',()=>{
  smoothVal.textContent=(+smooth.value).toFixed(2);
  deadVal.textContent=(+deadzone.value).toFixed(2);
  fricVal.textContent=(+fric.value).toFixed(3);
}));

const quantize=document.getElementById('quantize');
const scale=document.getElementById('scale');
const gainMax=document.getElementById('gainMax');
const waveRead=document.getElementById('waveRead');

const dmAvail=document.getElementById('dmAvail');
const doAvail=document.getElementById('doAvail');
const dxVal=document.getElementById('dxVal');
const dyVal=document.getElementById('dyVal');
const dzVal=document.getElementById('dzVal');

const xRead=document.getElementById('xRead');
const yRead=document.getElementById('yRead');
const zRead=document.getElementById('zRead');
const pitchRead=document.getElementById('pitchRead');
const volRead=document.getElementById('volRead');
const envRead=document.getElementById('envRead');

dmAvail.textContent='DeviceMotion: ' + (typeof DeviceMotionEvent!=='undefined' ? 'OK' : 'brak');
doAvail.textContent='DeviceOrientation: ' + (typeof DeviceOrientationEvent!=='undefined' ? 'OK' : 'brak');

btnAudio.onclick = async ()=>{ initAudio(); if (audio.state==='suspended') await audio.resume(); running=true; };
btnStop.onclick = ()=>{ running=false; setGate(false); };
btnNote.onclick = ()=> setGate(!gate);

// ===== Czujniki → przyspieszenia =====
let ax=0, ay=0, az=0, baseAx=0, baseAy=0, baseAz=0;
async function enableSensors(){
  try{
    if (typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
      const ok=await DeviceMotionEvent.requestPermission(); if(ok!=='granted') throw new Error('Brak zgody DeviceMotion');
    }
    if (typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
      try{ await DeviceOrientationEvent.requestPermission(); }catch(_){}
    }
  }catch(_){}
  window.addEventListener('devicemotion', e=>{
    const src = e.acceleration || e.accelerationIncludingGravity || {x:0,y:0,z:0};
    ax = (src.x||0); ay=(src.y||0); az=(src.z||0);
    dxVal.textContent=ax.toFixed(3);
    dyVal.textContent=ay.toFixed(3);
    dzVal.textContent=az.toFixed(3);
  }, true);
}
btnSensors.onclick=enableSensors;
btnCal.onclick=()=>{ baseAx=ax; baseAy=ay; baseAz=az; };
btnZero.onclick=()=>{ posX=0; posY=0; posZ=0; };

// ===== Pozycja (integracja kontrolowana) =====
// pozycje w metrach, ograniczenia i „tarcie”
let posX=0, posY=0, posZ=0;         // m
let velX=0, velY=0, velZ=0;         // m/s
let lastT=null;

function stepPosition(dt){
  const dz = +deadzone.value;
  // relatywne przyspieszenie (po kalibracji)
  let rx=ax-baseAx, ry=ay-baseAy, rz=az-baseAz;

  // deadzone
  if (Math.abs(rx)<dz) rx=0;
  if (Math.abs(ry)<dz) ry=0;
  if (Math.abs(rz)<dz) rz=0;

  // integracja z tarciem (friction) → „przyspiesz/zwalniaj”
  const F = +fric.value; // 0.90..0.999
  velX = velX*F + rx*dt;
  velY = velY*F + ry*dt;
  velZ = velZ*F + rz*dt;

  // pozycja (zachowuje się przy braku ruchu)
  posX += velX*dt;
  posY += velY*dt;
  posZ += velZ*dt;

  // ograniczenia pozycji (clamp do zadanych zasięgów)
  const maxX = +rangeX.value;
  const maxY = +rangeY.value;
  const maxZ = +rangeZ.value * 0.5; // pół-grubości

  posX = clamp(posX, -maxX, maxX);
  posY = clamp(posY, 0, maxY); // Y od „nisko” (0) do „wysoko” (maxY)
  posZ = clamp(posZ, -maxZ*2, maxZ*2); // luz poza płaszczyzną, ale gate weźmie maxZ

  // gate: histereza + debounce
  if (autoGate.checked){
    const level = Math.abs(rx)+Math.abs(ry)+Math.abs(rz)*0.5;
    const onThr = +gateOnThr.value, offThr = +gateOffThr.value;
    const now = performance.now();
    if (!gate && level>onThr && now>(gateDebounceUntil||0)){ gateDebounceUntil=now+ +debounceMs.value; setGate(true); }
    else if (gate && level<offThr && now>(gateDebounceUntil||0)){ gateDebounceUntil=now+ +debounceMs.value; setGate(false); }
  }
}
let gateDebounceUntil=0;

// ===== Pitch/volume z pozycji =====
function freqFromY(y){
  // y in [0..rangeY] → oktawy logarytmicznie
  const base = +pitchBase.value;      // np. 220 Hz
  const oct = +octaves.value;         // np. 2
  const maxY = +rangeY.value;
  const yNorm = clamp(y/maxY, 0, 1);
  let octSpan = oct * yNorm;
  if (noLimit.checked && y>maxY){ octSpan += (y-maxY)/(maxY)*oct; } // ponad – dodaj kolejne okt.
  const f = base * Math.pow(2, octSpan);
  return f;
}

function quantizeFreq(freq){
  if (!quantize.checked || scale.value==='none') return freq;
  const SCALES={major:[0,2,4,5,7,9,11], minor:[0,2,3,5,7,8,10], pent:[0,2,4,7,9]};
  const sc=SCALES[scale.value]; if(!sc) return freq;
  const midi=69+12*Math.log2(freq/440);
  let best=Math.round(midi),bestD=1e9;
  for(let k=-24;k<=24;k++){
    const cand=Math.round(midi)+k;
    const deg=((cand%12)+12)%12;
    if(sc.includes(deg)){const d=Math.abs(cand-midi); if(d<bestD){bestD=d; best=cand;}}
  }
  return 440*Math.pow(2,(best-69)/12);
}

// ===== Rysunek =====
const canvas=document.getElementById('canvas'); const ctx=canvas.getContext('2d');
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#031017'; ctx.fillRect(0,0,canvas.width,canvas.height);

  // pasek pitch
  const f=osc?osc.frequency.value:0;
  const maxF = 220 * Math.pow(2, +octaves.value+2); // tylko do wizualizacji
  const fx = Math.min(canvas.width, (f/maxF)*canvas.width);
  ctx.fillStyle='#0f8'; ctx.fillRect(0,10,fx,18); ctx.fillStyle='#9fb'; ctx.fillText('Freq: '+Math.round(f)+' Hz',6,24);

  // pasek volume (volGain)
  const vg=volGain?volGain.gain.value:0;
  ctx.fillStyle='#f84'; ctx.fillRect(0,40, vg*canvas.width,18); ctx.fillStyle='#ffd2b0'; ctx.fillText('Vol: '+vg.toFixed(2),6,54);

  // waveform
  if (analyser){
    let buf=new Uint8Array(analyser.fftSize);
    analyser.getByteTimeDomainData(buf);
    ctx.beginPath(); ctx.strokeStyle='#6cf'; ctx.lineWidth=1;
    const step=canvas.width/buf.length;
    for(let i=0;i<buf.length;i++){
      const v=buf[i]/128.0;
      const y=110+(v-1)*50;
      if(i===0) ctx.moveTo(0,y); else ctx.lineTo(i*step,y);
    }
    ctx.stroke();
  }

  // Z gate area wizualnie
  const zHalf= (+rangeZ.value*0.5);
  ctx.fillStyle='rgba(255,255,255,0.08)';
  ctx.fillRect(0, canvas.height-20, canvas.width, 4);
  ctx.fillText('Z-plane ±'+zHalf.toFixed(2)+' m (|Z|>'+zHalf.toFixed(2)+' → mute)', 6, canvas.height-8);
}

// ===== Pętla =====
let smoothPitch=null;
function loop(t){
  if (running){
    const now=t||performance.now();
    if (lastT==null) lastT=now;
    const dt=Math.min(0.05, Math.max(0.001,(now-lastT)/1000)); lastT=now;

    stepPosition(dt);

    // mapowanie: X→pitch (po log), Y→volume (linear)
    let freq = freqFromY(posY); // Uwaga: Y steruje tutaj wysokością wg Twojego życzenia 2 oktawy
    freq = quantizeFreq(freq);

    const s=+smooth.value;
    if (smoothPitch==null) smoothPitch=freq;
    smoothPitch = lerp(smoothPitch, freq, 1-s);

    // Z warstwa: poza płaszczyzną wyciszamy
    const zActive = Math.abs(posZ) <= (+rangeZ.value * 0.5);

    if (osc)  osc.frequency.setTargetAtTime(smoothPitch, audio.currentTime, 0.02);
    if (volGain){
      const vol = zActive ? clamp(posX/(+rangeX.value)*0.5+0.5, 0, 1) * 1.0 : 0.0; // X w [-maxX..+maxX] → 0..1
      volGain.gain.setTargetAtTime(vol, audio.currentTime, 0.03);
    }

    // Jeśli Z wyłącza — zamknij gate; jeśli wracasz — otwórz
    if (autoGate.checked){
      if (!zActive && gate) setGate(false);
      if (zActive && !gate) setGate(true);
    }

    // odczyty
    xRead.textContent=posX.toFixed(3);
    yRead.textContent=posY.toFixed(3);
    zRead.textContent=posZ.toFixed(3);
    pitchRead.textContent=Math.round(smoothPitch);
    volRead.textContent=(volGain?volGain.gain.value:0).toFixed(2);
    envRead.textContent=(env?env.gain.value:0).toFixed(2);

    draw();
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// Init / resume
document.addEventListener('visibilitychange', async ()=>{
  if (audio && audio.state==='suspended' && document.visibilityState==='visible'){
    try{ await audio.resume(); }catch(_){}
  }
});
})();
</script>
</body>
</html>
